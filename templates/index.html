<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>"수와 양" 튼튼 교실(ver 1.06)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: Pretendard, sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .bounce { animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .fraction-container { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; margin: 0 4px; }
        .fraction-line { width: 100%; border-top: 2px solid currentColor; margin: 2px 0; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col items-center justify-center">

    <div id="app" class="w-full max-w-3xl min-h-screen bg-white shadow-2xl md:min-h-[800px] md:h-auto md:rounded-3xl relative overflow-hidden flex flex-col"></div>

    <script>
        const API_URL = "/api/generate-problems"; 

        const TOTAL_PROBLEMS = 10;
        const PASS_THRESHOLD = 7;
        const AI_TOTAL_PROBLEMS = 5;

        let state = {
            view: 'menu', 
            mode: null, 
            score: 0,
            streak: 0,
            problemCount: 0,
            correctCount: 0,
            question: null,
            feedback: null,
            completedLevels: [],
            aiTopic: '',
            aiMathType: 'fraction',
            isAiLoading: false,
            aiError: null,
            aiProblemSet: []
        };

        try {
            const saved = localStorage.getItem('drill_completed_levels');
            if (saved) state.completedLevels = JSON.parse(saved);
        } catch (e) { console.error(e); }

        const app = document.getElementById('app');

        // --- 수학 유틸리티 함수 ---
        function gcd(a, b) {
            return b === 0 ? a : gcd(b, a % b);
        }

        function simplifyFrac(num, den) {
            const common = gcd(Math.abs(num), Math.abs(den));
            return { n: num / common, d: den / common };
        }

        function fracToHtmlStr(n, d) {
            const s = simplifyFrac(n, d);
            n = s.n; d = s.d;
            
            if (d === 1) return `<span class="text-2xl font-bold">${n}</span>`; 
            
            const w = Math.floor(n / d);
            const remN = n % d;
            
            if (remN === 0) return `<span class="text-2xl font-bold">${w}</span>`; 
            
            if (w > 0) {
                return `<div class="flex items-center gap-1 justify-center"><span class="text-2xl font-bold">${w}</span>${makeFractionDisplay(0, remN, d)}</div>`;
            }
            return makeFractionDisplay(0, n, d);
        }

        function makeFractionDisplay(whole, num, den) {
            const fracPart = `<div class="fraction-container text-2xl font-bold text-slate-800"><span>${num}</span><span class="fraction-line border-slate-800"></span><span>${den}</span></div>`;
            if (whole > 0) {
                return `<div class="flex items-center gap-1 justify-center"><span class="text-3xl font-bold">${whole}</span>${fracPart}</div>`;
            }
            return fracPart;
        }

        // --- 렌더링 함수들 ---
        function render() {
            app.innerHTML = '';
            if (state.view === 'menu') renderMenu();
            else if (state.view === 'playing') renderGame();
            else if (state.view === 'result') renderResult();
            else if (state.view === 'ai-setup') renderAiSetup();
            lucide.createIcons();
        }

        function renderMenu() {
             const isDecimalUnlocked = state.completedLevels.includes('fraction');
            const isCompareUnlocked = state.completedLevels.includes('decimal');
            const isAiUnlocked = state.completedLevels.includes('compare');

            const template = `
                <div class="flex flex-col items-center justify-center h-full p-6 fade-in overflow-y-auto">
                    <header class="mb-8 text-center relative w-full pt-8">
                        <div class="inline-block p-4 bg-blue-100 rounded-full mb-4">
                            <i data-lucide="calculator" class="w-12 h-12 text-blue-600"></i>
                        </div>
                        <h1 class="text-3xl font-extrabold text-slate-800 mb-2">"수와 양" 튼튼 교실(ver 1.06)</h1>
                        <p class="text-lg text-slate-600">각 단계 <span class="text-orange-600 font-bold">${PASS_THRESHOLD}문제 이상</span> 맞춰야 통과!</p>
                        ${state.completedLevels.length > 0 ? `<button onclick="resetProgress()" class="absolute right-0 top-0 text-xs text-slate-400 underline hover:text-slate-600">초기화</button>` : ''}
                    </header>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full pb-8">
                        <button onclick="startGame('fraction')" class="group relative bg-white border-2 border-orange-200 p-6 rounded-2xl shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all flex flex-col items-center">
                            ${state.completedLevels.includes('fraction') ? '<div class="absolute top-4 right-4 bg-orange-100 text-orange-600 p-1 rounded-full"><i data-lucide="check-circle" class="w-5 h-5"></i></div>' : ''}
                            <div class="bg-orange-100 p-4 rounded-full mb-4 group-hover:bg-orange-200 transition-colors">
                                <i data-lucide="brain" class="w-8 h-8 text-orange-600"></i>
                            </div>
                            <h2 class="text-xl font-bold mb-1">1. 분수 마스터</h2>
                            <p class="text-sm text-slate-500">분수와 대분수의 나눗셈<br>(10문제)</p>
                        </button>
                        <button onclick="${isDecimalUnlocked ? "startGame('decimal')" : ''}" class="group relative p-6 rounded-2xl border-2 transition-all flex flex-col items-center ${isDecimalUnlocked ? 'bg-white border-emerald-200 hover:shadow-xl hover:-translate-y-1 cursor-pointer' : 'bg-slate-100 border-slate-200 opacity-70 cursor-not-allowed'}">
                            ${!isDecimalUnlocked ? '<div class="absolute inset-0 bg-slate-100/50 flex items-center justify-center rounded-2xl"><i data-lucide="lock" class="w-10 h-10 text-slate-400"></i></div>' : ''}
                            ${state.completedLevels.includes('decimal') ? '<div class="absolute top-4 right-4 bg-emerald-100 text-emerald-600 p-1 rounded-full z-10"><i data-lucide="check-circle" class="w-5 h-5"></i></div>' : ''}
                            <div class="p-4 rounded-full mb-4 ${isDecimalUnlocked ? 'bg-emerald-100' : 'bg-slate-200'}">
                                <i data-lucide="ruler" class="w-8 h-8 ${isDecimalUnlocked ? 'text-emerald-600' : 'text-slate-400'}"></i>
                            </div>
                            <h2 class="text-xl font-bold mb-1">2. 소수 사냥꾼</h2>
                            <p class="text-sm text-slate-500">소수점 위치와 나눗셈<br>(10문제)</p>
                        </button>
                        <button onclick="${isCompareUnlocked ? "startGame('compare')" : ''}" class="group relative p-6 rounded-2xl border-2 transition-all flex flex-col items-center ${isCompareUnlocked ? 'bg-white border-indigo-200 hover:shadow-xl hover:-translate-y-1 cursor-pointer' : 'bg-slate-100 border-slate-200 opacity-70 cursor-not-allowed'}">
                             ${!isCompareUnlocked ? '<div class="absolute inset-0 bg-slate-100/50 flex items-center justify-center rounded-2xl"><i data-lucide="lock" class="w-10 h-10 text-slate-400"></i></div>' : ''}
                             ${state.completedLevels.includes('compare') ? '<div class="absolute top-4 right-4 bg-indigo-100 text-indigo-600 p-1 rounded-full z-10"><i data-lucide="check-circle" class="w-5 h-5"></i></div>' : ''}
                            <div class="p-4 rounded-full mb-4 ${isCompareUnlocked ? 'bg-indigo-100' : 'bg-slate-200'}">
                                <i data-lucide="trophy" class="w-8 h-8 ${isCompareUnlocked ? 'text-indigo-600' : 'text-slate-400'}"></i>
                            </div>
                            <h2 class="text-xl font-bold mb-1">3. 크기 비교 왕</h2>
                            <p class="text-sm text-slate-500">분수 vs 소수 심화<br>(10문제)</p>
                        </button>
                        <button onclick="${isAiUnlocked ? "setupAi()" : ''}" class="group relative p-6 rounded-2xl border-2 transition-all flex flex-col items-center ${isAiUnlocked ? 'bg-gradient-to-br from-violet-500 to-fuchsia-600 border-transparent hover:shadow-xl hover:-translate-y-1 cursor-pointer text-white' : 'bg-slate-100 border-slate-200 opacity-70 cursor-not-allowed'}">
                             ${!isAiUnlocked ? '<div class="absolute inset-0 bg-slate-100/50 flex items-center justify-center rounded-2xl"><i data-lucide="lock" class="w-10 h-10 text-slate-400"></i></div>' : ''}
                             ${state.completedLevels.includes('ai') ? '<div class="absolute top-4 right-4 bg-white/20 p-1 rounded-full z-10"><i data-lucide="check-circle" class="w-5 h-5 text-white"></i></div>' : ''}
                            <div class="p-4 rounded-full mb-4 ${isAiUnlocked ? 'bg-white/20' : 'bg-slate-200'}">
                                <i data-lucide="sparkles" class="w-8 h-8 ${isAiUnlocked ? 'text-white' : 'text-slate-400'}"></i>
                            </div>
                            <h2 class="text-xl font-bold mb-1">4. AI 보너스</h2>
                            <p class="text-sm ${isAiUnlocked ? 'text-white/80' : 'text-slate-500'}">나만의 문제 만들기<br>(5문제)</p>
                            ${isAiUnlocked ? '<div class="absolute top-4 right-4 bg-white/20 px-2 py-1 rounded text-xs font-bold">UNLOCKED</div>' : ''}
                        </button>
                    </div>
                </div>
            `;
            app.innerHTML = template;
        }

        function renderGame() {
             const total = state.mode === 'ai' ? AI_TOTAL_PROBLEMS : TOTAL_PROBLEMS;
            const progress = (state.problemCount / total) * 100;
            const q = state.question;

            const optionsHtml = q.options.map((opt, idx) => `
                <button onclick="handleAnswer(${idx})" 
                    ${state.feedback ? 'disabled' : ''}
                    class="p-4 md:p-6 rounded-2xl text-xl font-bold shadow-sm transition-all transform active:scale-95 whitespace-normal border flex items-center justify-center min-h-[100px]
                    ${state.feedback 
                        ? (opt === q.answer ? 'bg-green-500 text-white ring-4 ring-green-200 border-green-500' : 'bg-slate-100 text-slate-300 border-slate-100')
                        : 'bg-white text-slate-700 hover:bg-blue-50 hover:text-blue-600 hover:shadow-md border-slate-100'
                    }">
                    ${opt}
                </button>
            `).join('');

            const template = `
                <div class="bg-white p-4 shadow-sm flex justify-between items-center sticky top-0 z-10">
                    <div class="flex items-center gap-4">
                        <button onclick="goToMenu()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x-circle"></i></button>
                        <div>
                            <span class="text-xs font-bold text-slate-400 block">MODE</span>
                            <span class="text-sm font-bold text-slate-700">
                                ${state.mode === 'fraction' ? '1. 분수 마스터' : 
                                  state.mode === 'decimal' ? '2. 소수 사냥꾼' : 
                                  state.mode === 'compare' ? '3. 크기 비교 왕' : '4. AI 보너스'}
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                             <span class="text-xs font-bold text-slate-400 block">정답</span>
                             <span class="${state.correctCount >= PASS_THRESHOLD && state.mode !== 'ai' ? 'text-green-600' : 'text-slate-600'} font-bold">
                                ${state.correctCount} / ${total}
                             </span>
                        </div>
                    </div>
                </div>
                <div class="w-full bg-slate-200 h-2">
                    <div class="h-2 transition-all duration-500 ${state.mode === 'ai' ? 'bg-violet-500' : 'bg-green-500'}" style="width: ${progress}%"></div>
                </div>
                <div class="flex-1 flex flex-col items-center justify-center p-6 relative bg-slate-50 overflow-y-auto">
                    <div class="mb-4 text-slate-500 font-medium bg-slate-200 px-3 py-1 rounded-full text-sm">
                        문제 ${state.problemCount} / ${total}
                    </div>
                    <div class="bg-white rounded-3xl p-8 md:p-12 shadow-lg mb-8 w-full text-center flex justify-center items-center min-h-[200px] flex-col">
                        ${q.isAi ? `<div class="mb-4 flex items-center gap-2 text-violet-500 font-bold bg-violet-50 px-3 py-1 rounded-full text-sm"><i data-lucide="sparkles" class="w-4 h-4"></i> ${state.aiTopic} 테마</div>` : ''}
                        <div class="text-2xl font-medium leading-relaxed flex flex-wrap items-center justify-center gap-2">
                            ${q.text}
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                        ${optionsHtml}
                    </div>
                </div>
                ${state.feedback ? `
                    <div class="absolute bottom-24 left-6 right-6 p-4 rounded-xl shadow-xl border-l-8 text-left z-20 fade-in
                        ${state.feedback.type === 'correct' ? 'bg-green-50 border-green-500 text-green-800' : 'bg-red-50 border-red-500 text-red-800'}">
                        <div class="flex items-start gap-3">
                            <i data-lucide="${state.feedback.type === 'correct' ? 'check-circle' : 'x-circle'}" class="shrink-0"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-1">${state.feedback.type === 'correct' ? '정답입니다!' : '아쉬워요!'}</h3>
                                <p class="text-sm opacity-90 whitespace-pre-line">${state.feedback.msg}</p>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            app.innerHTML = template;
        }

        function renderResult() {
             const isPass = state.mode === 'ai' || state.correctCount >= PASS_THRESHOLD;
            const total = state.mode === 'ai' ? AI_TOTAL_PROBLEMS : TOTAL_PROBLEMS;
            const percent = (state.correctCount / total) * 100;

            const nextMsg = state.mode === 'fraction' ? '축하합니다!<br>다음 단계 [소수 사냥꾼]이 열렸습니다!' :
                            state.mode === 'decimal' ? '축하합니다!<br>다음 단계 [크기 비교 왕]이 열렸습니다!' :
                            state.mode === 'compare' ? '대단해요!<br>최종 보상 [AI 보너스]가 열렸습니다!' :
                            '모든 훈련을 훌륭하게 마쳤습니다!';

            const template = `
                <div class="flex flex-col items-center justify-center h-full p-6 fade-in text-center">
                    <div class="mb-6">
                        ${isPass 
                            ? '<div class="bg-yellow-100 p-6 rounded-full bounce"><i data-lucide="trophy" class="w-16 h-16 text-yellow-500"></i></div>'
                            : '<div class="bg-red-100 p-6 rounded-full"><i data-lucide="frown" class="w-16 h-16 text-red-500"></i></div>'
                        }
                    </div>
                    <h2 class="text-3xl font-bold text-slate-800 mb-2">${isPass ? (state.mode === 'ai' ? '보너스 미션 성공!' : '스테이지 클리어!') : '미션 실패!'}</h2>
                    <p class="text-slate-600 mb-8">${isPass ? nextMsg : `아쉽네요! ${PASS_THRESHOLD}문제 이상 맞춰야 통과입니다.<br>조금만 더 집중해서 다시 도전해볼까요?`}</p>
                    <div class="bg-slate-50 rounded-xl p-6 mb-8 w-full max-w-md">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-slate-500">정답 수</span>
                            <span class="text-2xl font-bold ${isPass ? 'text-blue-600' : 'text-red-600'}">${state.correctCount} / ${total}</span>
                        </div>
                        <div class="relative w-full bg-slate-200 rounded-full h-4 mt-2">
                             ${state.mode !== 'ai' ? `<div class="absolute top-0 bottom-0 w-1 bg-black/20 z-10" style="left: ${(PASS_THRESHOLD/total)*100}%"></div>` : ''}
                            <div class="h-4 rounded-full transition-all duration-1000 ${isPass ? 'bg-blue-500' : 'bg-red-500'}" style="width: ${percent}%"></div>
                        </div>
                        ${state.mode !== 'ai' ? `<p class="text-xs text-slate-400 mt-1 text-right">목표: ${PASS_THRESHOLD}개</p>` : ''}
                    </div>
                    <div class="flex gap-4">
                        ${!isPass ? `<button onclick="startGame('${state.mode}')" class="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors"><i data-lucide="rotate-ccw"></i> 다시 도전하기</button>` : ''}
                        <button onclick="goToMenu()" class="flex items-center gap-2 px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-300 transition-colors">${isPass ? '메뉴로 돌아가기' : '그만하기'}</button>
                    </div>
                </div>
            `;
            app.innerHTML = template;
        }

        function renderAiSetup() {
            const template = `
                <div class="flex flex-col items-center justify-center h-full p-6 fade-in bg-violet-50 w-full h-full">
                    <div class="max-w-md w-full bg-white p-8 rounded-3xl shadow-xl">
                        <div class="text-center mb-6">
                            <i data-lucide="sparkles" class="inline-block text-violet-500 mb-2 w-12 h-12"></i>
                            <h2 class="text-2xl font-bold text-slate-800">나만의 수학 문제 만들기</h2>
                            <p class="text-slate-500">좋아하는 주제를 알려주세요!</p>
                        </div>
                        <div class="space-y-4 mb-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">어떤 주제가 좋나요?</label>
                                <input type="text" id="ai-topic-input" value="${state.aiTopic}" placeholder="예: 마인크래프트, 탕후루, 손흥민" class="w-full p-4 bg-slate-100 rounded-xl border-2 border-transparent focus:border-violet-500 outline-none transition-all font-bold">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">문제 유형</label>
                                <div class="flex gap-2">
                                    <button onclick="setAiMathType('fraction')" class="flex-1 p-3 rounded-xl border-2 font-bold transition-colors ${state.aiMathType === 'fraction' ? 'border-violet-500 bg-violet-50 text-violet-700' : 'border-slate-200 text-slate-400'}">분수</button>
                                    <button onclick="setAiMathType('decimal')" class="flex-1 p-3 rounded-xl border-2 font-bold transition-colors ${state.aiMathType === 'decimal' ? 'border-violet-500 bg-violet-50 text-violet-700' : 'border-slate-200 text-slate-400'}">소수</button>
                                </div>
                            </div>
                        </div>
                        ${state.aiError ? `<div class="mb-4 p-3 bg-red-50 text-red-500 rounded-lg text-sm text-center font-bold">${state.aiError}</div>` : ''}
                        <div class="flex flex-col gap-3">
                            <button onclick="generateAIProblemSet()" ${state.isAiLoading ? 'disabled' : ''} class="w-full py-4 bg-violet-600 text-white rounded-xl font-bold text-lg hover:bg-violet-700 transition-all flex justify-center items-center gap-2 disabled:opacity-50">
                                ${state.isAiLoading ? '<i data-lucide="loader-2" class="animate-spin"></i> 만드는 중...' : '<i data-lucide="sparkles"></i> 문제 세트 만들기'}
                            </button>
                            <button onclick="goToMenu()" class="w-full py-3 text-slate-400 font-bold hover:text-slate-600">뒤로 가기</button>
                        </div>
                    </div>
                </div>
            `;
            app.innerHTML = template;
            document.getElementById('ai-topic-input').addEventListener('input', (e) => state.aiTopic = e.target.value);
        }

        // --- 로직 함수들 ---

        function goToMenu() { state.view = 'menu'; render(); }
        function startGame(mode) {
            state.mode = mode; state.score = 0; state.streak = 0; state.correctCount = 0; state.problemCount = 1; state.feedback = null; state.view = 'playing';
            generateProblem(); render();
        }
        function setupAi() { state.view = 'ai-setup'; state.aiError = null; render(); }
        function setAiMathType(type) { state.aiMathType = type; render(); }
        function resetProgress() { if(confirm('정말 초기화하시겠습니까?')) { state.completedLevels = []; localStorage.removeItem('drill_completed_levels'); render(); } }
        
        function handleAnswer(idx) {
            if (state.feedback) return;
            const selectedOpt = state.question.options[idx];
            const isCorrect = String(selectedOpt) === String(state.question.answer);
            if (isCorrect) {
                state.score += 10 + (state.streak * 2); state.streak++; state.correctCount++;
                state.feedback = { type: 'correct', msg: state.question.isAi ? state.question.explanation : '정답입니다! 참 잘했어요.' };
            } else {
                state.streak = 0; state.feedback = { type: 'incorrect', msg: state.question.hint };
            }
            render();
            setTimeout(() => {
                const total = state.mode === 'ai' ? AI_TOTAL_PROBLEMS : TOTAL_PROBLEMS;
                if (state.problemCount >= total) {
                    if (state.mode === 'ai') completeLevel('ai');
                    else if (state.correctCount >= PASS_THRESHOLD) completeLevel(state.mode);
                    state.view = 'result'; render();
                } else {
                    state.problemCount++; state.feedback = null;
                    if (state.mode === 'ai') state.question = formatAiProblem(state.aiProblemSet[state.problemCount - 1]);
                    else generateProblem();
                    render();
                }
            }, isCorrect ? 1500 : 3000);
        }

        function completeLevel(mode) {
            if (!state.completedLevels.includes(mode)) {
                state.completedLevels.push(mode);
                localStorage.setItem('drill_completed_levels', JSON.stringify(state.completedLevels));
            }
        }

        // --- 문제 생성 로직 ---
        function generateProblem() {
            let p = {};
            
            if (state.mode === 'fraction') {
                const type = Math.random() > 0.5 ? 1 : 2; 
                
                const genFrac = (maxWhole, maxDen) => {
                    const d = Math.floor(Math.random() * (maxDen - 2)) + 2; 
                    const n = Math.floor(Math.random() * (d - 1)) + 1;
                    const w = Math.floor(Math.random() * maxWhole);
                    return { w, n, d };
                };

                const getImp = (f) => ({ n: f.w * f.d + f.n, d: f.d });

                const f1 = genFrac(4, 9); 
                const f2 = genFrac(3, 9);
                
                if (f2.w === 0 && f2.n === 0) f2.n = 1;

                p.text = `${makeFractionDisplay(f1.w, f1.n, f1.d)} <span class="mx-2">÷</span> ${makeFractionDisplay(f2.w, f2.n, f2.d)}`;
                
                const imp1 = getImp(f1);
                const imp2 = getImp(f2);
                
                const ansN = imp1.n * imp2.d;
                const ansD = imp1.d * imp2.n;
                
                p.answer = fracToHtmlStr(ansN, ansD);
                p.hint = "대분수를 가분수로 고친 뒤 역수를 곱해서 계산해보세요.";
                
                let opts = [p.answer];
                let loop = 0;
                while(opts.length < 4 && loop < 50) {
                    loop++;
                    let wrongN, wrongD;
                    const r = Math.random();
                    
                    if (r < 0.25) { 
                        wrongN = ansD; wrongD = ansN;
                    } else if (r < 0.5) { 
                        wrongN = ansN + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random()*5)+1);
                        wrongD = ansD;
                    } else if (r < 0.75) { 
                        wrongN = ansN;
                        wrongD = ansD + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random()*3)+1);
                    } else { 
                        wrongN = Math.max(1, ansN + (Math.floor(Math.random() * 10) - 5));
                        wrongD = ansD;
                    }
                    
                    if (wrongD <= 0) wrongD = 1;
                    if (wrongN <= 0) wrongN = 1;

                    const wrongHtml = fracToHtmlStr(wrongN, wrongD);
                    if (!opts.includes(wrongHtml)) {
                        opts.push(wrongHtml);
                    }
                }
                while(opts.length < 4) {
                     const fallbackN = ansN + opts.length;
                     opts.push(fracToHtmlStr(fallbackN, ansD));
                }
                opts.sort(() => Math.random() - 0.5);
                p.options = opts;

            } else if (state.mode === 'decimal') {
                const type = Math.random();
                if (type < 0.33) {
                    const a = (Math.floor(Math.random() * 90) + 10) / 10;
                    const b = (Math.floor(Math.random() * 90) + 10) / 10;
                    p.text = `${a} × ${b}`;
                    p.answer = parseFloat((a * b).toFixed(2));
                    p.hint = "소수점을 무시하고 계산한 뒤, 두 소수의 소수점 아래 자리 수 합만큼 찍어주세요.";
                } else if (type < 0.66) {
                    const result = (Math.floor(Math.random() * 90) + 10) / 10; 
                    const divisor = (Math.floor(Math.random() * 9) + 1) / 10; 
                    const dividend = parseFloat((result * divisor).toFixed(2));
                    p.text = `${dividend} ÷ ${divisor}`;
                    p.answer = result;
                    p.hint = "나누는 수와 나누어지는 수의 소수점을 똑같이 오른쪽으로 옮겨서 계산하세요.";
                } else {
                    const divisor = Math.random() > 0.5 ? 4 : (Math.random() > 0.5 ? 5 : 8); 
                    const dividend = Math.floor(Math.random() * 20) + 1; 
                    
                    // 안전한 계산 방식 적용 (eval 제거)
                    let finalDividend = dividend;
                    if (dividend % divisor === 0) finalDividend = dividend + 1;
                    
                    p.text = `${finalDividend} ÷ ${divisor}`;
                    p.answer = parseFloat((finalDividend / divisor).toFixed(3));
                    p.hint = "나누어 떨어지지 않을 때는 0을 내려서 계속 계산하세요.";
                }
                
                let opts = [p.answer];
                let loop = 0;
                while (opts.length < 4 && loop < 50) {
                    loop++;
                    let wrong;
                    const r = Math.random();
                    if (r < 0.2) wrong = p.answer * 10;
                    else if (r < 0.4) wrong = p.answer / 10;
                    else if (r < 0.6) wrong = p.answer + (Math.random() > 0.5 ? 1 : -1);
                    else wrong = p.answer + 0.1;
                    
                    let wrongFixed = parseFloat(wrong.toFixed(2));
                    if (!opts.some(o => Math.abs(o - wrongFixed) < 0.01)) opts.push(wrongFixed);
                }
                while(opts.length < 4) opts.push(parseFloat((p.answer + opts.length + 1).toFixed(2)));
                opts.sort(() => Math.random() - 0.5);
                p.options = opts;

            } else if (state.mode === 'compare') {
                const dens = [2, 4, 5, 8, 10, 20, 25, 40, 50];
                const den = dens[Math.floor(Math.random() * dens.length)];
                const whole = Math.floor(Math.random() * 6); 
                let num = Math.floor(Math.random() * (den - 1)) + 1;
                const fracVal = whole + (num / den);
                
                const diffType = Math.random();
                let decVal;
                if (diffType < 0.45) decVal = fracVal + (Math.random() * 0.09 + 0.01);
                else if (diffType < 0.9) decVal = fracVal - (Math.random() * 0.09 + 0.01);
                else decVal = fracVal;
                decVal = parseFloat(decVal.toFixed(2));
                
                const showFracLeft = Math.random() > 0.5;
                const fracHtml = makeFractionDisplay(whole, num, den);
                
                const leftContent = showFracLeft ? fracHtml : decVal;
                const rightContent = showFracLeft ? decVal : fracHtml;
                const leftValReal = showFracLeft ? fracVal : decVal;
                const rightValReal = showFracLeft ? decVal : fracVal;

                p.text = `<div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm border">${leftContent}</div><span class="text-slate-400 font-bold mx-2">vs</span><div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm border">${rightContent}</div>`;
                if (Math.abs(leftValReal - rightValReal) < 0.0001) p.answer = '=';
                else p.answer = leftValReal > rightValReal ? '>' : '<';
                p.type = 'compare';
                p.hint = "분수를 소수로 바꾸어 비교해보세요. (예: 1/4 = 0.25, 1/5 = 0.2, 1/8 = 0.125)";
                p.options = ['>', '<', '='];
            }
            state.question = p;
        }

        function toFractionHtml(val) {
            const whole = Math.floor(val);
            const decimal = Math.round((val - whole) * 100);
            const renderMixed = (n, d) => makeFractionDisplay(whole, n, d);
            if (decimal === 25) return renderMixed(1, 4);
            if (decimal === 50) return renderMixed(1, 2);
            if (decimal === 75) return renderMixed(3, 4);
            return val;
        }

        async function generateAIProblemSet() {
            if (!state.aiTopic) { state.aiError = "주제를 입력해주세요!"; render(); return; }
            state.isAiLoading = true; state.aiError = null; render();
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: state.aiTopic, mathType: state.aiMathType })
                });
                if (!res.ok) throw new Error('서버 연결 실패');
                const data = await res.json();
                startAiGame(data);
            } catch (err) {
                console.error(err);
                state.aiError = "AI 선생님을 부르는데 실패했어요."; state.isAiLoading = false; render();
            }
        }
        function startAiGame(problemSet) {
            state.aiProblemSet = problemSet; state.isAiLoading = false; state.problemCount = 1; state.score = 0; state.streak = 0; state.correctCount = 0; state.feedback = null; state.mode = 'ai';
            state.question = formatAiProblem(problemSet[0]); state.view = 'playing'; render();
        }
        function formatAiProblem(raw) {
            return { text: raw.question, options: raw.options, answer: raw.answer, hint: raw.hint, explanation: raw.explanation, isAi: true };
        }

        render();
    </script>
</body>
</html>
