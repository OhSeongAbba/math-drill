<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>"ìˆ˜ì™€ ì–‘" íŠ¼íŠ¼ êµì‹¤ (ver 1.05)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: Pretendard, sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .bounce { animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .fraction-container { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; margin: 0 4px; }
        .fraction-line { width: 100%; border-top: 2px solid currentColor; margin: 2px 0; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col items-center justify-center">

    <div id="app" class="w-full max-w-3xl min-h-screen bg-white shadow-2xl md:min-h-[800px] md:h-auto md:rounded-3xl relative overflow-hidden flex flex-col"></div>

    <script>
        // âš™ï¸ ì„¤ì • ì˜ì—­: ê°™ì€ ì„œë²„ ë‚´ API ì‚¬ìš©
        const API_URL = "/api/generate-problems"; 

        // ğŸ“ ìˆ˜ì •ëœ ë¶€ë¶„: ë¬¸ì œ ìˆ˜ 10ê°œ, í†µê³¼ ê¸°ì¤€ 7ê°œë¡œ ë³€ê²½
        const TOTAL_PROBLEMS = 10;
        const PASS_THRESHOLD = 7;
        const AI_TOTAL_PROBLEMS = 5;

        let state = {
            view: 'menu', 
            mode: null, 
            score: 0,
            streak: 0,
            problemCount: 0,
            correctCount: 0,
            question: null,
            feedback: null,
            completedLevels: [],
            aiTopic: '',
            aiMathType: 'fraction',
            isAiLoading: false,
            aiError: null,
            aiProblemSet: []
        };

        try {
            const saved = localStorage.getItem('drill_completed_levels');
            if (saved) state.completedLevels = JSON.parse(saved);
        } catch (e) { console.error(e); }

        const app = document.getElementById('app');

        // ë¶„ìˆ˜/ëŒ€ë¶„ìˆ˜ HTML ìƒì„± í—¬í¼ í•¨ìˆ˜
        function makeFractionDisplay(whole, num, den) {
            const fracPart = `<div class="fraction-container text-2xl font-bold text-slate-800"><span>${num}</span><span class="fraction-line border-slate-800"></span><span>${den}</span></div>`;
            if (whole > 0) {
                return `<div class="flex items-center gap-1"><span class="text-3xl font-bold">${whole}</span>${fracPart}</div>`;
            }
            return fracPart;
        }

        // --- ë Œë”ë§ í•¨ìˆ˜ë“¤ ---
        function render() {
            app.innerHTML = '';
            if (state.view === 'menu') renderMenu();
            else if (state.view === 'playing') renderGame();
            else if (state.view === 'result') renderResult();
            else if (state.view === 'ai-setup') renderAiSetup();
            lucide.createIcons();
        }

        function renderMenu() {
             const isDecimalUnlocked = state.completedLevels.includes('fraction');
            const isCompareUnlocked = state.completedLevels.includes('decimal');
            const isAiUnlocked = state.completedLevels.includes('compare');

            const template = `
                <div class="flex flex-col items-center justify-center h-full p-6 fade-in overflow-y-auto">
                    <header class="mb-8 text-center relative w-full pt-8">
                        <div class="inline-block p-4 bg-blue-100 rounded-full mb-4">
                            <i data-lucide="calculator" class="w-12 h-12 text-blue-600"></i>
                        </div>
                        <h1 class="text-3xl font-extrabold text-slate-800 mb-2">"ìˆ˜ì™€ ì–‘" íŠ¼íŠ¼ êµì‹¤ (ver 1.05)</h1>
                        <p class="text-lg text-slate-600">ê° ë‹¨ê³„ <span class="text-orange-600 font-bold">${PASS_THRESHOLD}ë¬¸ì œ ì´ìƒ</span> ë§ì¶°ì•¼ í†µê³¼!</p>
                        ${state.completedLevels.length > 0 ? `<button onclick="resetProgress()" class="absolute right-0 top-0 text-xs text-slate-400 underline hover:text-slate-600">ì´ˆê¸°í™”</button>` : ''}
                    </header>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full pb-8">
                        <button onclick="startGame('fraction')" class="group relative bg-white border-2 border-orange-200 p-6 rounded-2xl shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all flex flex-col items-center">
                            ${state.completedLevels.includes('fraction') ? '<div class="absolute top-4 right-4 bg-orange-100 text-orange-600 p-1 rounded-full"><i data-lucide="check-circle" class="w-5 h-5"></i></div>' : ''}
                            <div class="bg-orange-100 p-4 rounded-full mb-4 group-hover:bg-orange-200 transition-colors">
                                <i data-lucide="brain" class="w-8 h-8 text-orange-600"></i>
                            </div>
                            <h2 class="text-xl font-bold mb-1">1. ë¶„ìˆ˜ ë§ˆìŠ¤í„°</h2>
                            <p class="text-sm text-slate-500">ë¶„ìˆ˜ì™€ ëŒ€ë¶„ìˆ˜ì˜ ë‚˜ëˆ—ì…ˆ<br>(10ë¬¸ì œ)</p>
                        </button>
                        <button onclick="${isDecimalUnlocked ? "startGame('decimal')" : ''}" class="group relative p-6 rounded-2xl border-2 transition-all flex flex-col items-center ${isDecimalUnlocked ? 'bg-white border-emerald-200 hover:shadow-xl hover:-translate-y-1 cursor-pointer' : 'bg-slate-100 border-slate-200 opacity-70 cursor-not-allowed'}">
                            ${!isDecimalUnlocked ? '<div class="absolute inset-0 bg-slate-100/50 flex items-center justify-center rounded-2xl"><i data-lucide="lock" class="w-10 h-10 text-slate-400"></i></div>' : ''}
                            ${state.completedLevels.includes('decimal') ? '<div class="absolute top-4 right-4 bg-emerald-100 text-emerald-600 p-1 rounded-full z-10"><i data-lucide="check-circle" class="w-5 h-5"></i></div>' : ''}
                            <div class="p-4 rounded-full mb-4 ${isDecimalUnlocked ? 'bg-emerald-100' : 'bg-slate-200'}">
                                <i data-lucide="ruler" class="w-8 h-8 ${isDecimalUnlocked ? 'text-emerald-600' : 'text-slate-400'}"></i>
                            </div>
                            <h2 class="text-xl font-bold mb-1">2. ì†Œìˆ˜ ì‚¬ëƒ¥ê¾¼</h2>
                            <p class="text-sm text-slate-500">ì†Œìˆ˜ì  ìœ„ì¹˜ì™€ ë‚˜ëˆ—ì…ˆ<br>(10ë¬¸ì œ)</p>
                        </button>
                        <button onclick="${isCompareUnlocked ? "startGame('compare')" : ''}" class="group relative p-6 rounded-2xl border-2 transition-all flex flex-col items-center ${isCompareUnlocked ? 'bg-white border-indigo-200 hover:shadow-xl hover:-translate-y-1 cursor-pointer' : 'bg-slate-100 border-slate-200 opacity-70 cursor-not-allowed'}">
                             ${!isCompareUnlocked ? '<div class="absolute inset-0 bg-slate-100/50 flex items-center justify-center rounded-2xl"><i data-lucide="lock" class="w-10 h-10 text-slate-400"></i></div>' : ''}
                             ${state.completedLevels.includes('compare') ? '<div class="absolute top-4 right-4 bg-indigo-100 text-indigo-600 p-1 rounded-full z-10"><i data-lucide="check-circle" class="w-5 h-5"></i></div>' : ''}
                            <div class="p-4 rounded-full mb-4 ${isCompareUnlocked ? 'bg-indigo-100' : 'bg-slate-200'}">
                                <i data-lucide="trophy" class="w-8 h-8 ${isCompareUnlocked ? 'text-indigo-600' : 'text-slate-400'}"></i>
                            </div>
                            <h2 class="text-xl font-bold mb-1">3. í¬ê¸° ë¹„êµ ì™•</h2>
                            <p class="text-sm text-slate-500">ë¶„ìˆ˜ vs ì†Œìˆ˜ ì‹¬í™”<br>(10ë¬¸ì œ)</p>
                        </button>
                        <button onclick="${isAiUnlocked ? "setupAi()" : ''}" class="group relative p-6 rounded-2xl border-2 transition-all flex flex-col items-center ${isAiUnlocked ? 'bg-gradient-to-br from-violet-500 to-fuchsia-600 border-transparent hover:shadow-xl hover:-translate-y-1 cursor-pointer text-white' : 'bg-slate-100 border-slate-200 opacity-70 cursor-not-allowed'}">
                             ${!isAiUnlocked ? '<div class="absolute inset-0 bg-slate-100/50 flex items-center justify-center rounded-2xl"><i data-lucide="lock" class="w-10 h-10 text-slate-400"></i></div>' : ''}
                             ${state.completedLevels.includes('ai') ? '<div class="absolute top-4 right-4 bg-white/20 p-1 rounded-full z-10"><i data-lucide="check-circle" class="w-5 h-5 text-white"></i></div>' : ''}
                            <div class="p-4 rounded-full mb-4 ${isAiUnlocked ? 'bg-white/20' : 'bg-slate-200'}">
                                <i data-lucide="sparkles" class="w-8 h-8 ${isAiUnlocked ? 'text-white' : 'text-slate-400'}"></i>
                            </div>
                            <h2 class="text-xl font-bold mb-1">4. AI ë³´ë„ˆìŠ¤</h2>
                            <p class="text-sm ${isAiUnlocked ? 'text-white/80' : 'text-slate-500'}">ë‚˜ë§Œì˜ ë¬¸ì œ ë§Œë“¤ê¸°<br>(5ë¬¸ì œ)</p>
                            ${isAiUnlocked ? '<div class="absolute top-4 right-4 bg-white/20 px-2 py-1 rounded text-xs font-bold">UNLOCKED</div>' : ''}
                        </button>
                    </div>
                </div>
            `;
            app.innerHTML = template;
        }

        function renderGame() {
             const total = state.mode === 'ai' ? AI_TOTAL_PROBLEMS : TOTAL_PROBLEMS;
            const progress = (state.problemCount / total) * 100;
            const q = state.question;

            const optionsHtml = q.options.map(opt => `
                <button onclick="handleAnswer('${opt}')" 
                    ${state.feedback ? 'disabled' : ''}
                    class="p-6 rounded-2xl text-xl font-bold shadow-sm transition-all transform active:scale-95 whitespace-normal border
                    ${state.feedback 
                        ? (opt == q.answer ? 'bg-green-500 text-white ring-4 ring-green-200 border-green-500' : 'bg-slate-100 text-slate-300 border-slate-100')
                        : 'bg-white text-slate-700 hover:bg-blue-50 hover:text-blue-600 hover:shadow-md border-slate-100'
                    }">
                    ${opt}
                </button>
            `).join('');

            const template = `
                <div class="bg-white p-4 shadow-sm flex justify-between items-center sticky top-0 z-10">
                    <div class="flex items-center gap-4">
                        <button onclick="goToMenu()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x-circle"></i></button>
                        <div>
                            <span class="text-xs font-bold text-slate-400 block">MODE</span>
                            <span class="text-sm font-bold text-slate-700">
                                ${state.mode === 'fraction' ? '1. ë¶„ìˆ˜ ë§ˆìŠ¤í„°' : 
                                  state.mode === 'decimal' ? '2. ì†Œìˆ˜ ì‚¬ëƒ¥ê¾¼' : 
                                  state.mode === 'compare' ? '3. í¬ê¸° ë¹„êµ ì™•' : '4. AI ë³´ë„ˆìŠ¤'}
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                             <span class="text-xs font-bold text-slate-400 block">ì •ë‹µ</span>
                             <span class="${state.correctCount >= PASS_THRESHOLD && state.mode !== 'ai' ? 'text-green-600' : 'text-slate-600'} font-bold">
                                ${state.correctCount} / ${total}
                             </span>
                        </div>
                    </div>
                </div>
                <div class="w-full bg-slate-200 h-2">
                    <div class="h-2 transition-all duration-500 ${state.mode === 'ai' ? 'bg-violet-500' : 'bg-green-500'}" style="width: ${progress}%"></div>
                </div>
                <div class="flex-1 flex flex-col items-center justify-center p-6 relative bg-slate-50 overflow-y-auto">
                    <div class="mb-4 text-slate-500 font-medium bg-slate-200 px-3 py-1 rounded-full text-sm">
                        ë¬¸ì œ ${state.problemCount} / ${total}
                    </div>
                    <div class="bg-white rounded-3xl p-8 md:p-12 shadow-lg mb-8 w-full text-center flex justify-center items-center min-h-[200px] flex-col">
                        ${q.isAi ? `<div class="mb-4 flex items-center gap-2 text-violet-500 font-bold bg-violet-50 px-3 py-1 rounded-full text-sm"><i data-lucide="sparkles" class="w-4 h-4"></i> ${state.aiTopic} í…Œë§ˆ</div>` : ''}
                        <div class="text-2xl font-medium leading-relaxed flex flex-wrap items-center justify-center gap-2">
                            ${q.text}
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                        ${optionsHtml}
                    </div>
                </div>
                ${state.feedback ? `
                    <div class="absolute bottom-24 left-6 right-6 p-4 rounded-xl shadow-xl border-l-8 text-left z-20 fade-in
                        ${state.feedback.type === 'correct' ? 'bg-green-50 border-green-500 text-green-800' : 'bg-red-50 border-red-500 text-red-800'}">
                        <div class="flex items-start gap-3">
                            <i data-lucide="${state.feedback.type === 'correct' ? 'check-circle' : 'x-circle'}" class="shrink-0"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-1">${state.feedback.type === 'correct' ? 'ì •ë‹µì…ë‹ˆë‹¤!' : 'ì•„ì‰¬ì›Œìš”!'}</h3>
                                <p class="text-sm opacity-90 whitespace-pre-line">${state.feedback.msg}</p>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            app.innerHTML = template;
        }

        function renderResult() {
             const isPass = state.mode === 'ai' || state.correctCount >= PASS_THRESHOLD;
            const total = state.mode === 'ai' ? AI_TOTAL_PROBLEMS : TOTAL_PROBLEMS;
            const percent = (state.correctCount / total) * 100;

            const nextMsg = state.mode === 'fraction' ? 'ì¶•í•˜í•©ë‹ˆë‹¤!<br>ë‹¤ìŒ ë‹¨ê³„ [ì†Œìˆ˜ ì‚¬ëƒ¥ê¾¼]ì´ ì—´ë ¸ìŠµë‹ˆë‹¤!' :
                            state.mode === 'decimal' ? 'ì¶•í•˜í•©ë‹ˆë‹¤!<br>ë‹¤ìŒ ë‹¨ê³„ [í¬ê¸° ë¹„êµ ì™•]ì´ ì—´ë ¸ìŠµë‹ˆë‹¤!' :
                            state.mode === 'compare' ? 'ëŒ€ë‹¨í•´ìš”!<br>ìµœì¢… ë³´ìƒ [AI ë³´ë„ˆìŠ¤]ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤!' :
                            'ëª¨ë“  í›ˆë ¨ì„ í›Œë¥­í•˜ê²Œ ë§ˆì³¤ìŠµë‹ˆë‹¤!';

            const template = `
                <div class="flex flex-col items-center justify-center h-full p-6 fade-in text-center">
                    <div class="mb-6">
                        ${isPass 
                            ? '<div class="bg-yellow-100 p-6 rounded-full bounce"><i data-lucide="trophy" class="w-16 h-16 text-yellow-500"></i></div>'
                            : '<div class="bg-red-100 p-6 rounded-full"><i data-lucide="frown" class="w-16 h-16 text-red-500"></i></div>'
                        }
                    </div>
                    <h2 class="text-3xl font-bold text-slate-800 mb-2">${isPass ? (state.mode === 'ai' ? 'ë³´ë„ˆìŠ¤ ë¯¸ì…˜ ì„±ê³µ!' : 'ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´!') : 'ë¯¸ì…˜ ì‹¤íŒ¨!'}</h2>
                    <p class="text-slate-600 mb-8">${isPass ? nextMsg : `ì•„ì‰½ë„¤ìš”! ${PASS_THRESHOLD}ë¬¸ì œ ì´ìƒ ë§ì¶°ì•¼ í†µê³¼ì…ë‹ˆë‹¤.<br>ì¡°ê¸ˆë§Œ ë” ì§‘ì¤‘í•´ì„œ ë‹¤ì‹œ ë„ì „í•´ë³¼ê¹Œìš”?`}</p>
                    <div class="bg-slate-50 rounded-xl p-6 mb-8 w-full max-w-md">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-slate-500">ì •ë‹µ ìˆ˜</span>
                            <span class="text-2xl font-bold ${isPass ? 'text-blue-600' : 'text-red-600'}">${state.correctCount} / ${total}</span>
                        </div>
                        <div class="relative w-full bg-slate-200 rounded-full h-4 mt-2">
                             ${state.mode !== 'ai' ? `<div class="absolute top-0 bottom-0 w-1 bg-black/20 z-10" style="left: ${(PASS_THRESHOLD/total)*100}%"></div>` : ''}
                            <div class="h-4 rounded-full transition-all duration-1000 ${isPass ? 'bg-blue-500' : 'bg-red-500'}" style="width: ${percent}%"></div>
                        </div>
                        ${state.mode !== 'ai' ? `<p class="text-xs text-slate-400 mt-1 text-right">ëª©í‘œ: ${PASS_THRESHOLD}ê°œ</p>` : ''}
                    </div>
                    <div class="flex gap-4">
                        ${!isPass ? `<button onclick="startGame('${state.mode}')" class="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors"><i data-lucide="rotate-ccw"></i> ë‹¤ì‹œ ë„ì „í•˜ê¸°</button>` : ''}
                        <button onclick="goToMenu()" class="flex items-center gap-2 px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-300 transition-colors">${isPass ? 'ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°' : 'ê·¸ë§Œí•˜ê¸°'}</button>
                    </div>
                </div>
            `;
            app.innerHTML = template;
        }

        function renderAiSetup() {
            const template = `
                <div class="flex flex-col items-center justify-center h-full p-6 fade-in bg-violet-50 w-full h-full">
                    <div class="max-w-md w-full bg-white p-8 rounded-3xl shadow-xl">
                        <div class="text-center mb-6">
                            <i data-lucide="sparkles" class="inline-block text-violet-500 mb-2 w-12 h-12"></i>
                            <h2 class="text-2xl font-bold text-slate-800">ë‚˜ë§Œì˜ ìˆ˜í•™ ë¬¸ì œ ë§Œë“¤ê¸°</h2>
                            <p class="text-slate-500">ì¢‹ì•„í•˜ëŠ” ì£¼ì œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”!</p>
                        </div>
                        <div class="space-y-4 mb-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">ì–´ë–¤ ì£¼ì œê°€ ì¢‹ë‚˜ìš”?</label>
                                <input type="text" id="ai-topic-input" value="${state.aiTopic}" placeholder="ì˜ˆ: ë§ˆì¸í¬ë˜í”„íŠ¸, íƒ•í›„ë£¨, ì†í¥ë¯¼" class="w-full p-4 bg-slate-100 rounded-xl border-2 border-transparent focus:border-violet-500 outline-none transition-all font-bold">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">ë¬¸ì œ ìœ í˜•</label>
                                <div class="flex gap-2">
                                    <button onclick="setAiMathType('fraction')" class="flex-1 p-3 rounded-xl border-2 font-bold transition-colors ${state.aiMathType === 'fraction' ? 'border-violet-500 bg-violet-50 text-violet-700' : 'border-slate-200 text-slate-400'}">ë¶„ìˆ˜</button>
                                    <button onclick="setAiMathType('decimal')" class="flex-1 p-3 rounded-xl border-2 font-bold transition-colors ${state.aiMathType === 'decimal' ? 'border-violet-500 bg-violet-50 text-violet-700' : 'border-slate-200 text-slate-400'}">ì†Œìˆ˜</button>
                                </div>
                            </div>
                        </div>
                        ${state.aiError ? `<div class="mb-4 p-3 bg-red-50 text-red-500 rounded-lg text-sm text-center font-bold">${state.aiError}</div>` : ''}
                        <div class="flex flex-col gap-3">
                            <button onclick="generateAIProblemSet()" ${state.isAiLoading ? 'disabled' : ''} class="w-full py-4 bg-violet-600 text-white rounded-xl font-bold text-lg hover:bg-violet-700 transition-all flex justify-center items-center gap-2 disabled:opacity-50">
                                ${state.isAiLoading ? '<i data-lucide="loader-2" class="animate-spin"></i> ë§Œë“œëŠ” ì¤‘...' : '<i data-lucide="sparkles"></i> ë¬¸ì œ ì„¸íŠ¸ ë§Œë“¤ê¸°'}
                            </button>
                            <button onclick="goToMenu()" class="w-full py-3 text-slate-400 font-bold hover:text-slate-600">ë’¤ë¡œ ê°€ê¸°</button>
                        </div>
                    </div>
                </div>
            `;
            app.innerHTML = template;
            document.getElementById('ai-topic-input').addEventListener('input', (e) => state.aiTopic = e.target.value);
        }

        // --- ë¡œì§ í•¨ìˆ˜ë“¤ ---

        function goToMenu() { state.view = 'menu'; render(); }
        function startGame(mode) {
            state.mode = mode; state.score = 0; state.streak = 0; state.correctCount = 0; state.problemCount = 1; state.feedback = null; state.view = 'playing';
            generateProblem(); render();
        }
        function setupAi() { state.view = 'ai-setup'; state.aiError = null; render(); }
        function setAiMathType(type) { state.aiMathType = type; render(); }
        function resetProgress() { if(confirm('ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { state.completedLevels = []; localStorage.removeItem('drill_completed_levels'); render(); } }
        
        function handleAnswer(selectedOpt) {
            if (state.feedback) return;
            const isCorrect = String(selectedOpt) === String(state.question.answer);
            if (isCorrect) {
                state.score += 10 + (state.streak * 2); state.streak++; state.correctCount++;
                state.feedback = { type: 'correct', msg: state.question.isAi ? state.question.explanation : 'ì •ë‹µì…ë‹ˆë‹¤! ì°¸ ì˜í–ˆì–´ìš”.' };
            } else {
                state.streak = 0; state.feedback = { type: 'incorrect', msg: state.question.hint };
            }
            render();
            setTimeout(() => {
                const total = state.mode === 'ai' ? AI_TOTAL_PROBLEMS : TOTAL_PROBLEMS;
                if (state.problemCount >= total) {
                    if (state.mode === 'ai') completeLevel('ai');
                    else if (state.correctCount >= PASS_THRESHOLD) completeLevel(state.mode);
                    state.view = 'result'; render();
                } else {
                    state.problemCount++; state.feedback = null;
                    if (state.mode === 'ai') state.question = formatAiProblem(state.aiProblemSet[state.problemCount - 1]);
                    else generateProblem();
                    render();
                }
            }, isCorrect ? 1500 : 3000);
        }

        function completeLevel(mode) {
            if (!state.completedLevels.includes(mode)) {
                state.completedLevels.push(mode);
                localStorage.setItem('drill_completed_levels', JSON.stringify(state.completedLevels));
            }
        }

        // --- ë¬¸ì œ ìƒì„± ë¡œì§ (ë‚œì´ë„ ìƒí–¥ ë²„ì „) ---
        function generateProblem() {
            let p = {};
            
            if (state.mode === 'fraction') {
                // ë¶„ìˆ˜ ë§ˆìŠ¤í„°: ëŒ€ë¶„ìˆ˜ ë‚˜ëˆ—ì…ˆ í¬í•¨ (6í•™ë…„ 2í•™ê¸° ìˆ˜ì¤€)
                const type = Math.random() > 0.5 ? 1 : 2; // 1: ëŒ€ë¶„ìˆ˜ Ã· ë¶„ìˆ˜, 2: ëŒ€ë¶„ìˆ˜ Ã· ëŒ€ë¶„ìˆ˜
                
                // Helper: Generate Fraction Object {w, n, d, val}
                const genFrac = (maxWhole, maxDen) => {
                    const d = Math.floor(Math.random() * (maxDen - 2)) + 2; // 2 ~ maxDen
                    const n = Math.floor(Math.random() * (d - 1)) + 1;
                    const w = Math.floor(Math.random() * maxWhole);
                    const val = (w * d + n) / d;
                    return { w, n, d, val };
                };

                const f1 = genFrac(4, 9); // ëŒ€ë¶„ìˆ˜ ê°€ëŠ¥ì„± ë†’ìŒ
                const f2 = genFrac(3, 9);

                // Ensure f2 is not 0 (though genFrac logic prevents 0/0, w=0 and n>0 ensures value > 0)
                // Also ensure division yields reasonable result (not too huge/tiny)
                // Just randomize operations slightly to guarantee "Mixed Number" appearance
                
                // Force at least one mixed number for visual difficulty
                if (f1.w === 0 && f2.w === 0) f1.w = 1; 

                p.text = `${makeFractionDisplay(f1.w, f1.n, f1.d)} <span class="mx-2">Ã·</span> ${makeFractionDisplay(f2.w, f2.n, f2.d)}`;
                
                // Calculate answer
                const ansVal = f1.val / f2.val;
                
                // Answer formatting: Simplify to Mixed Number or Proper Fraction for options?
                // For this drill, we'll store float for comparison but display options as integers/decimals if clean, or approximate
                // Ideally, options should be Fraction strings, but our handleAnswer checks String equality.
                // Let's use simplified float checking for now, but generated options will be floats.
                // *Challenge*: Rendering fractional options in buttons is hard with simple strings.
                // We will stick to Decimal/Integer answers if possible, OR make the problem result in clean integers/simple fractions.
                
                // Strategy: Generate simple Answer first, then derive Question
                // Ans = a/b. Let F2 = c/d. Then F1 = Ans * F2.
                // This ensures clean answers.
                
                // New Strategy: Reverse Engineering
                const ansN = Math.floor(Math.random() * 5) + 1; // 1~5
                const ansD = Math.floor(Math.random() * 4) + 1; // 1~4
                const ans = ansN / ansD; // Result
                
                const f2_d = Math.floor(Math.random() * 8) + 2; 
                const f2_n = Math.floor(Math.random() * (f2_d * 3 - 1)) + 1; // Allows mixed numbers
                const f2_val = f2_n / f2_d;
                
                const f1_val = ans * f2_val;
                
                // We need to display f1 and f2 as fractions.
                // f1 might be complex. Let's stick to the original random generation 
                // and round answers to 2 decimal places for checking, or use approximate options.
                // Given the constraint of the current UI (button options), keeping options as numbers is safer.
                
                p.answer = parseFloat(ansVal.toFixed(2));
                p.hint = "ëŒ€ë¶„ìˆ˜ë¥¼ ê°€ë¶„ìˆ˜ë¡œ ê³ ì¹œ ë’¤ ê³„ì‚°í•˜ì„¸ìš”. ì—­ìˆ˜ë¥¼ ê³±í•˜ëŠ” ê²ƒ ìŠì§€ ë§ˆì„¸ìš”!";

            } else if (state.mode === 'decimal') {
                // ì†Œìˆ˜ ì‚¬ëƒ¥ê¾¼: ë‚œì´ë„ ìƒí–¥ (ì†Œìˆ˜ Ã· ì†Œìˆ˜, ìì—°ìˆ˜ Ã· ìì—°ìˆ˜ = ì†Œìˆ˜)
                const type = Math.random();
                
                if (type < 0.33) {
                    // 1. ì†Œìˆ˜ x ì†Œìˆ˜ (ìë¦¬ìˆ˜ ëŠ˜ë¦¼)
                    const a = (Math.floor(Math.random() * 90) + 10) / 10; // 1.0 ~ 9.9
                    const b = (Math.floor(Math.random() * 90) + 10) / 10; // 1.0 ~ 9.9
                    p.text = `${a} Ã— ${b}`;
                    p.answer = parseFloat((a * b).toFixed(2));
                    p.hint = "ì†Œìˆ˜ì ì„ ë¬´ì‹œí•˜ê³  ê³„ì‚°í•œ ë’¤, ë‘ ì†Œìˆ˜ì˜ ì†Œìˆ˜ì  ì•„ë˜ ìë¦¬ ìˆ˜ í•©ë§Œí¼ ì°ì–´ì£¼ì„¸ìš”.";
                } else if (type < 0.66) {
                    // 2. ì†Œìˆ˜ Ã· ì†Œìˆ˜ (ê²°ê³¼ê°€ ê¹”ë”í•˜ê²Œ)
                    const result = (Math.floor(Math.random() * 90) + 10) / 10; // 1.0 ~ 9.9
                    const divisor = (Math.floor(Math.random() * 9) + 1) / 10; // 0.1 ~ 0.9
                    const dividend = parseFloat((result * divisor).toFixed(2));
                    p.text = `${dividend} Ã· ${divisor}`;
                    p.answer = result;
                    p.hint = "ë‚˜ëˆ„ëŠ” ìˆ˜ì™€ ë‚˜ëˆ„ì–´ì§€ëŠ” ìˆ˜ì˜ ì†Œìˆ˜ì ì„ ë˜‘ê°™ì´ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì˜®ê²¨ì„œ ê³„ì‚°í•˜ì„¸ìš”.";
                } else {
                    // 3. ìì—°ìˆ˜ Ã· ìì—°ìˆ˜ (ëª«ì´ ì†Œìˆ˜)
                    const divisor = Math.random() > 0.5 ? 4 : (Math.random() > 0.5 ? 5 : 8); // 4, 5, 8 (end cleanly)
                    const dividend = Math.floor(Math.random() * 20) + 1; 
                    // Make sure it's not evenly divisible
                    if (dividend % divisor === 0) p.text = `${dividend + 1} Ã· ${divisor}`;
                    else p.text = `${dividend} Ã· ${divisor}`;
                    
                    p.answer = parseFloat((eval(p.text)).toFixed(3)); // Evaluate text directly
                    p.hint = "ë‚˜ëˆ„ì–´ ë–¨ì–´ì§€ì§€ ì•Šì„ ë•ŒëŠ” 0ì„ ë‚´ë ¤ì„œ ê³„ì† ê³„ì‚°í•˜ì„¸ìš”.";
                }

            } else if (state.mode === 'compare') {
                // (ì´ì „ ìƒí–¥ëœ ë¡œì§ ìœ ì§€)
                const dens = [2, 4, 5, 8, 10, 20, 25, 40, 50];
                const den = dens[Math.floor(Math.random() * dens.length)];
                const whole = Math.floor(Math.random() * 6); 
                let num = Math.floor(Math.random() * (den - 1)) + 1;
                const fracVal = whole + (num / den);
                
                const diffType = Math.random();
                let decVal;
                if (diffType < 0.45) decVal = fracVal + (Math.random() * 0.09 + 0.01);
                else if (diffType < 0.9) decVal = fracVal - (Math.random() * 0.09 + 0.01);
                else decVal = fracVal;
                decVal = parseFloat(decVal.toFixed(2));
                
                const showFracLeft = Math.random() > 0.5;
                const fracHtml = makeFractionDisplay(whole, num, den);
                
                const leftContent = showFracLeft ? fracHtml : decVal;
                const rightContent = showFracLeft ? decVal : fracHtml;
                const leftValReal = showFracLeft ? fracVal : decVal;
                const rightValReal = showFracLeft ? decVal : fracVal;

                p.text = `<div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm border">${leftContent}</div><span class="text-slate-400 font-bold mx-2">vs</span><div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm border">${rightContent}</div>`;
                if (Math.abs(leftValReal - rightValReal) < 0.0001) p.answer = '=';
                else p.answer = leftValReal > rightValReal ? '>' : '<';
                p.type = 'compare';
                p.hint = "ë¶„ìˆ˜ë¥¼ ì†Œìˆ˜ë¡œ ë°”ê¾¸ì–´ ë¹„êµí•´ë³´ì„¸ìš”. (ì˜ˆ: 1/4 = 0.25, 1/5 = 0.2, 1/8 = 0.125)";
            }

            // --- ì˜¤ë‹µ ìƒì„± (ê³µí†µ) ---
            let opts = [p.answer];
            if (p.type === 'compare') {
                opts = ['>', '<', '='];
            } else {
                let loopGuard = 0;
                while (opts.length < 4 && loopGuard < 50) {
                    loopGuard++;
                    let wrong;
                    
                    // ì˜¤ë‹µ íŒ¨í„´ ë‹¤ì–‘í™”
                    const r = Math.random();
                    if (r < 0.2) wrong = p.answer * 10;
                    else if (r < 0.4) wrong = p.answer / 10;
                    else if (r < 0.6) wrong = p.answer + (Math.random() > 0.5 ? 1 : -1);
                    else if (r < 0.8) wrong = p.answer + (Math.random() > 0.5 ? 0.1 : -0.1);
                    else wrong = p.answer * (Math.random() * 0.5 + 0.5);

                    let wrongFixed = parseFloat(wrong.toFixed(2));
                    if (!opts.some(o => Math.abs(o - wrongFixed) < 0.01) && !isNaN(wrongFixed)) {
                        opts.push(wrongFixed);
                    }
                }
                while (opts.length < 4) opts.push(parseFloat((p.answer + opts.length + 1).toFixed(2))); // Fallback
                opts.sort(() => Math.random() - 0.5);
            }
            p.options = opts;
            state.question = p;
        }

        function toFractionHtml(val) {
            const whole = Math.floor(val);
            const decimal = Math.round((val - whole) * 100);
            const renderMixed = (n, d) => makeFractionDisplay(whole, n, d);
            if (decimal === 25) return renderMixed(1, 4);
            if (decimal === 50) return renderMixed(1, 2);
            if (decimal === 75) return renderMixed(3, 4);
            return val;
        }

        // ... (ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤ì€ ì´ì „ê³¼ ë™ì¼) ...
        
        // (í•„ìˆ˜ í•¨ìˆ˜ë“¤ ì¬ì„ ì–¸ - ì „ì²´ ì½”ë“œ ë³µë¶™ìš©)
        async function generateAIProblemSet() {
            if (!state.aiTopic) { state.aiError = "ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!"; render(); return; }
            state.isAiLoading = true; state.aiError = null; render();
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: state.aiTopic, mathType: state.aiMathType })
                });
                if (!res.ok) throw new Error('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
                const data = await res.json();
                startAiGame(data);
            } catch (err) {
                console.error(err);
                state.aiError = "AI ì„ ìƒë‹˜ì„ ë¶€ë¥´ëŠ”ë° ì‹¤íŒ¨í–ˆì–´ìš”."; state.isAiLoading = false; render();
            }
        }
        function startAiGame(problemSet) {
            state.aiProblemSet = problemSet; state.isAiLoading = false; state.problemCount = 1; state.score = 0; state.streak = 0; state.correctCount = 0; state.feedback = null; state.mode = 'ai';
            state.question = formatAiProblem(problemSet[0]); state.view = 'playing'; render();
        }
        function formatAiProblem(raw) {
            return { text: raw.question, options: raw.options, answer: raw.answer, hint: raw.hint, explanation: raw.explanation, isAi: true };
        }

        render();
    </script>
</body>
</html>
